<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#31bf8a">
    <title>AeroNexa - Profile</title>
    <link rel="icon" type="image/png" href="image/logo1_1.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo-section">
                <img src="image/logo1_1.png" alt="AeroNexa Logo" class="logo">
                <span class="logo-text">eroNexa</span>
            </div>
            <div class="header-actions">
                <a href="alerts.html" class="icon-button">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </a>
                <a href="profile.html" class="user-info">
                    <i class="fas fa-user-circle"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <section class="page active">
            <div class="container">
                <div class="profile-card">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user-circle"></i>
                        <img id="profileAvatarImg" style="display: none;" alt="Profile Picture">
                    </div>
                    <h3 id="userName">Loading...</h3>
                    <p id="userEmail">Loading...</p>
                </div>

                <div class="profile-menu">
                    <a href="alerts.html" class="menu-item">
                        <i class="fas fa-bell"></i>
                        <span>Notifications</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="settings.html" class="menu-item">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="history.html" class="menu-item">
                        <i class="fas fa-history"></i>
                        <span>History</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="analytics.html" class="menu-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Analytics</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <div class="menu-item" onclick="showAboutModal()">
                        <i class="fas fa-info-circle"></i>
                        <span>About AeroNexa</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="menu-item danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>

                <div class="app-info">
                    <img src="image/logo.png" alt="AeroNexa Logo" class="about-logo">
                    <p class="slogan">AI-Driven Solutions for Indoor Air Quality: Addressing Building Related Illness and Health Risks</p>
                    <p class="version">Version 1.0.0</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="devices.html" class="nav-item">
            <i class="fas fa-microchip"></i>
            <span>Devices</span>
        </a>
        <a href="analytics.html" class="nav-item">
            <i class="fas fa-chart-line"></i>
            <span>Analytics</span>
        </a>
        <a href="alerts.html" class="nav-item">
            <i class="fas fa-bell"></i>
            <span>Alerts</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- About Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>About AeroNexa</h3>
                <button class="modal-close" onclick="closeAboutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <img src="image/logo_2.png" alt="AeroNexa" class="modal-logo">
                <h4>AeroNexa v1.0.0</h4>
                <p class="modal-description">
                    AeroNexa is an AI-based air quality monitoring solution designed to detect and prevent Building Related Illness (BRI) and health risks related to indoor air quality.
                </p>
                <div class="modal-features">
                    <h5>Key Features:</h5>
                    <ul>
                        <li><i class="fas fa-check"></i> Real-time monitoring of 7 air parameters</li>
                        <li><i class="fas fa-check"></i> AI-powered recommendations</li>
                        <li><i class="fas fa-check"></i> Analytics & trend analysis</li>
                        <li><i class="fas fa-check"></i> Multi-room comparison</li>
                        <li><i class="fas fa-check"></i> Alert & notification system</li>
                    </ul>
                </div>
                <div class="modal-sensors">
                    <h5>Sensors Used:</h5>
                    <div class="sensor-badges">
                        <span class="sensor-badge">PMS5003</span>
                        <span class="sensor-badge">MH-Z19</span>
                        <span class="sensor-badge">BME280</span>
                        <span class="sensor-badge">MQ-2</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration file with API keys (must be loaded first) -->
    <script src="config.js"></script>
    <!-- Firebase Config must be loaded after config.js -->
    <script type="module" src="firebase-config.js"></script>
    <!-- Auth Guard - protects this page -->
    <script type="module" src="auth-guard.js"></script>
    <!-- User Avatar Handler -->
    <script type="module" src="user-avatar.js"></script>
    
    <script>
        /**
         * Load and display user profile data from Firestore
         */
        async function loadUserProfile() {
            try {
                // Wait for Firebase to be ready
                let maxAttempts = 100;
                let attempts = 0;
                
                while (!window.firebaseAuth || !window.firebaseGetUserFromFirestore || !window.waitForAuthCheck) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                    if (attempts > maxAttempts) {
                        console.error('Firebase not ready');
                        return;
                    }
                }

                // CRITICAL: Wait for auth check to complete before loading profile
                const user = await window.waitForAuthCheck();
                if (!user) {
                    // User not authenticated - auth guard should redirect
                    // But just in case, redirect here too
                    if (window.location.pathname.includes('profile.html')) {
                        window.location.href = 'auth.html';
                    }
                    return;
                }

                // Get current user UID (should be available now)
                const userId = window.getCurrentUserUID();
                if (!userId) {
                    // Double check - redirect if still no UID
                    window.location.href = 'auth.html';
                    return;
                }

                // Try to get user data from Firestore first
                let userData = await window.firebaseGetUserFromFirestore(userId);

                // If Firestore data not available, use Auth data as fallback
                if (!userData) {
                    const authUser = window.firebaseAuth.currentUser;
                    if (authUser) {
                        userData = {
                            displayName: authUser.displayName,
                            email: authUser.email,
                            photoURL: authUser.photoURL
                        };
                    }
                }

                // Update profile card with user data
                if (userData) {
                    const userNameEl = document.getElementById('userName');
                    const userEmailEl = document.getElementById('userEmail');
                    const profileAvatarEl = document.getElementById('profileAvatar');
                    const profileAvatarImgEl = document.getElementById('profileAvatarImg');
                    const profileAvatarIcon = profileAvatarEl.querySelector('i');

                    // Update name
                    if (userData.displayName) {
                        userNameEl.textContent = userData.displayName;
                    } else if (userData.email) {
                        userNameEl.textContent = userData.email.split('@')[0];
                    } else {
                        userNameEl.textContent = 'User';
                    }

                    // Update email
                    if (userData.email) {
                        userEmailEl.textContent = userData.email;
                    } else {
                        userEmailEl.textContent = 'No email';
                    }

                    // Update avatar - show photo if available (from Google login)
                    if (userData.photoURL) {
                        profileAvatarIcon.style.display = 'none';
                        profileAvatarImgEl.src = userData.photoURL;
                        profileAvatarImgEl.style.display = 'block';
                        profileAvatarImgEl.style.width = '100%';
                        profileAvatarImgEl.style.height = '100%';
                        profileAvatarImgEl.style.objectFit = 'cover';
                        profileAvatarImgEl.style.borderRadius = '50%';
                    } else {
                        profileAvatarIcon.style.display = 'block';
                        profileAvatarImgEl.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                
                // Fallback to display auth data
                const authUser = window.firebaseAuth?.currentUser;
                if (authUser) {
                    document.getElementById('userName').textContent = authUser.displayName || authUser.email?.split('@')[0] || 'User';
                    document.getElementById('userEmail').textContent = authUser.email || 'No email';
                }
            }
        }

        // Wait for auth check to complete before loading profile
        async function initializeProfile() {
            // Wait for auth check event or timeout
            if (window.waitForAuthCheck) {
                await window.waitForAuthCheck();
            } else {
                // Fallback: wait a bit for auth guard to initialize
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Now load profile
            loadUserProfile();
        }

        // Listen for auth check complete event
        window.addEventListener('authCheckComplete', (event) => {
            if (event.detail && event.detail.user) {
                loadUserProfile();
            }
        });

        // Initialize when page loads
        window.addEventListener('load', () => {
            initializeProfile();
        });

        // Also try if page already loaded
        if (document.readyState === 'complete') {
            initializeProfile();
        }
    </script>
    
    <script src="app.js"></script>
</body>
</html>
