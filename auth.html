<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#31bf8a">
    <title>AeroNexa - Authentication</title>
    <link rel="icon" type="image/png" href="image/logo1_1.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase Configuration (Separate File) -->
    <script type="module" src="firebase-config.js"></script>
    
    <style>
        /* ===== Reset & Base Styles ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide scrollbar globally */
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        *::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }

        /* Remove underline from all links */
        a {
            text-decoration: none;
        }

        a:hover {
            text-decoration: none;
        }

        :root {
            --primary-color: #31bf8a;
            --primary-dark: #2aa876;
            --primary-light: #4dd9a5;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --white: #ffffff;
            --bg-light: #f5f7fa;
            --danger: #e74c3c;
            --success: #27ae60;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --gradient-primary: linear-gradient(135deg, #31bf8a 0%, #2aa876 50%, #1e8e6e 100%);
            --gradient-overlay: linear-gradient(135deg, rgba(49, 191, 138, 0.9) 0%, rgba(42, 168, 118, 0.9) 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--gradient-primary);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            overflow-x: hidden;
            /* Hide scrollbar */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        body::-webkit-scrollbar {
            display: none;
        }

        /* Background decorative elements */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
            z-index: 0;
        }

        /* ===== Auth Container ===== */
        .auth-container {
            background: var(--white);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 480px;
            padding: 40px;
            position: relative;
            z-index: 1;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Logo Section */
        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-logo img {
            height: 120px;
            width: auto;
            margin-bottom: 0;
            filter: drop-shadow(0 4px 8px rgba(49, 191, 138, 0.2));
        }

        .auth-logo h1 {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-navbar);
            margin-bottom: 0;
            letter-spacing: -0.5px;
        }

        .auth-logo p {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }


        /* Form Styles */
        .auth-form {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .auth-form.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        /* Ensure input wrapper only contains one toggle */
        .form-input-wrapper .password-toggle {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Ensure only one toggle button per wrapper */
        .form-input-wrapper .password-toggle ~ .password-toggle {
            display: none !important;
        }

        .form-input {
            width: 100%;
            padding: 14px 48px 14px 16px;
            border: 2px solid #e8ecf0;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--text-dark);
        }

        /* Hide browser's default password reveal button - Chrome/Safari */
        input[type="password"]::-webkit-credentials-auto-fill-button {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: absolute !important;
            right: -9999px !important;
            width: 0 !important;
            height: 0 !important;
        }

        input[type="password"]::-webkit-textfield-decoration-container {
            display: none !important;
        }

        input[type="password"]::-webkit-strong-password-auto-fill-button {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        /* Hide Microsoft Edge/IE password reveal button */
        input[type="password"]::-ms-reveal,
        input[type="password"]::-ms-clear {
            display: none !important;
            visibility: hidden !important;
            width: 0 !important;
            height: 0 !important;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(49, 191, 138, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-light);
            opacity: 0.6;
        }

        /* Password Toggle Button */
        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            transition: color 0.3s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            width: auto;
            min-width: auto;
        }

        /* Ensure only one icon inside toggle button */
        .password-toggle i {
            display: inline-block !important;
            line-height: 1;
        }

        /* Remove Font Awesome pseudo-elements that might cause duplication */
        .password-toggle i.fas::before {
            display: block;
        }

        /* Prevent double rendering from any source */
        .password-toggle::before,
        .password-toggle::after {
            display: none !important;
            content: none !important;
        }

        /* Ensure button only contains one child (the icon) */
        .password-toggle {
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
        }

        /* Remove any duplicate icons */
        .password-toggle i ~ i {
            display: none !important;
        }

        .password-toggle:hover {
            color: var(--primary-color);
        }

        .password-toggle:hover i {
            color: inherit;
        }

        .password-toggle:focus {
            outline: none;
        }

        .password-toggle:focus i {
            outline: none;
        }

        /* Error Message */
        .error-message {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: none;
            animation: shake 0.4s ease;
        }

        .error-message.show {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Success Message */
        .success-message {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        /* Submit Button */
        .btn-submit {
            width: 100%;
            padding: 16px;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn-submit:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-submit.loading {
            color: transparent;
        }

        .btn-submit.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 3px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 24px 0;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 600;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e8ecf0;
        }

        .divider::before {
            margin-right: 16px;
        }

        .divider::after {
            margin-left: 16px;
        }

        /* Google Sign-In Button */
        .btn-google {
            width: 100%;
            padding: 14px 16px;
            background: var(--white);
            color: var(--text-dark);
            border: 2px solid #e8ecf0;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn-google:hover {
            border-color: #dadce0;
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .btn-google:active {
            transform: translateY(0);
        }

        /* Google Logo SVG - Authentic Google Colors */
        .google-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* Additional Options */
        .auth-options {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e8ecf0;
        }

        .auth-options p {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .auth-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 700;
            transition: color 0.3s ease;
        }

        .auth-link:hover {
            color: var(--primary-dark);
            text-decoration: none;
        }

        /* Forgot Password Link */
        .forgot-password {
            text-align: right;
            margin-top: -12px;
            margin-bottom: 20px;
        }

        .forgot-password a {
            font-size: 13px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .forgot-password a:hover {
            color: var(--primary-dark);
            text-decoration: none;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .auth-container {
                padding: 32px 24px;
                border-radius: 20px;
            }

            .auth-logo img {
                height: 100px;
            }

            .auth-logo h1 {
                font-size: 32px;
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            border: none;
            transform: none;
            overflow: hidden;
        }

        .loading-overlay.show {
            display: flex;
            position: fixed;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--white);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            position: relative;
            flex-shrink: 0;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Auth Container -->
    <div class="auth-container">
        <!-- Logo Section -->
        <div class="auth-logo">
            <img src="image/logo1.png" alt="AeroNexa Logo">
            <h1>AeroNexa</h1>
            <p>AI-Driven Air Quality Monitoring</p>
        </div>

        <!-- Error/Success Messages -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <!-- Login Form -->
        <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input 
                    type="email" 
                    id="loginEmail" 
                    class="form-input" 
                    placeholder="Enter your email"
                    required
                    autocomplete="email"
                >
            </div>

            <div class="form-group">
                <label for="loginPassword">Password</label>
                <div class="form-input-wrapper">
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="form-input" 
                        placeholder="Enter your password"
                        required
                        autocomplete="current-password"
                    >
                    <button 
                        type="button" 
                        class="password-toggle" 
                        onclick="togglePassword('loginPassword', this)"
                        aria-label="Toggle password visibility"
                    >
                        <i class="fas fa-eye" id="loginPasswordToggleIcon"></i>
                    </button>
                </div>
            </div>

            <div class="forgot-password">
                <a href="#" onclick="handleForgotPassword(event)">Forgot Password?</a>
            </div>

            <button type="submit" class="btn-submit" id="loginSubmitBtn">
                Sign In
            </button>

            <div class="divider">OR</div>

            <button type="button" class="btn-google" onclick="handleGoogleSignIn()">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
            </button>
        </form>

        <!-- Register Form -->
        <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
            <div class="form-group">
                <label for="registerName">Full Name</label>
                <input 
                    type="text" 
                    id="registerName" 
                    class="form-input" 
                    placeholder="Enter your full name"
                    required
                    autocomplete="name"
                >
            </div>

            <div class="form-group">
                <label for="registerEmail">Email</label>
                <input 
                    type="email" 
                    id="registerEmail" 
                    class="form-input" 
                    placeholder="Enter your email"
                    required
                    autocomplete="email"
                >
            </div>

            <div class="form-group">
                <label for="registerPassword">Password</label>
                <div class="form-input-wrapper">
                    <input 
                        type="password" 
                        id="registerPassword" 
                        class="form-input" 
                        placeholder="Create a password (min. 6 characters)"
                        required
                        autocomplete="new-password"
                        minlength="6"
                    >
                    <button 
                        type="button" 
                        class="password-toggle" 
                        onclick="togglePassword('registerPassword', this)"
                        aria-label="Toggle password visibility"
                    >
                        <i class="fas fa-eye" id="registerPasswordToggleIcon"></i>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label for="registerConfirmPassword">Confirm Password</label>
                <div class="form-input-wrapper">
                    <input 
                        type="password" 
                        id="registerConfirmPassword" 
                        class="form-input" 
                        placeholder="Confirm your password"
                        required
                        autocomplete="new-password"
                        minlength="6"
                    >
                    <button 
                        type="button" 
                        class="password-toggle" 
                        onclick="togglePassword('registerConfirmPassword', this)"
                        aria-label="Toggle password visibility"
                    >
                        <i class="fas fa-eye" id="registerConfirmPasswordToggleIcon"></i>
                    </button>
                </div>
            </div>

            <button type="submit" class="btn-submit" id="registerSubmitBtn">
                Create Account
            </button>

            <div class="divider">OR</div>

            <button type="button" class="btn-google" onclick="handleGoogleSignIn()">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
            </button>

            <div class="auth-options">
                <p>Already have an account? <a href="#" class="auth-link" onclick="switchTab('login', event)">Sign In</a></p>
            </div>
        </form>

        <!-- Login Form Additional Options -->
        <div class="auth-options" id="loginOptions">
            <p>Don't have an account? <a href="#" class="auth-link" onclick="switchTab('register', event)">Sign Up</a></p>
        </div>
    </div>

    <script>
        // Wait for Firebase to be ready
        let authReady = false;
        const checkAuthReady = setInterval(() => {
            if (window.firebaseAuth) {
                authReady = true;
                clearInterval(checkAuthReady);
                initAuth();
            }
        }, 100);

        /**
         * Determine redirect URL based on user email
         * Founder account redirects to founder.html, others to dashboard.html
         * @param {string} email - User email address
         * @returns {string} Redirect URL
         */
        function getRedirectUrl(email) {
            // Check if user is founder
            if (email === 'founder@aeronexa.com') {
                return 'founder.html';
            }
            // Default redirect to dashboard
            return 'dashboard.html';
        }

        // Initialize auth state listener
        // If user is already logged in, redirect to appropriate page
        function initAuth() {
            if (window.firebaseOnAuthStateChanged && window.firebaseAuth) {
                window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
                    if (user) {
                        // User is signed in, store UID and redirect
                        window.currentUserUID = user.uid;
                        window.currentUserEmail = user.email;
                        window.currentUserDisplayName = user.displayName;
                        window.currentUserPhotoURL = user.photoURL;
                        
                        // Redirect based on user email
                        const redirectUrl = getRedirectUrl(user.email);
                        console.log(`User already authenticated, redirecting to ${redirectUrl}`);
                        window.location.href = redirectUrl;
                    }
                });
            }
        }

        // Switch between login and register forms
        function switchTab(tab, event) {
            if (event) event.preventDefault();
            
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginOptions = document.getElementById('loginOptions');

            if (tab === 'login') {
                // Show login form, hide register form
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
                loginOptions.style.display = 'block';
            } else {
                // Show register form, hide login form
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
                loginOptions.style.display = 'none';
            }

            // Clear messages
            hideMessages();
        }

        // Toggle password visibility
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            // Get icon directly from button, ensure only one icon exists
            let icon = button.querySelector('i.fas');
            
            // If no icon found, create one
            if (!icon) {
                icon = document.createElement('i');
                icon.className = 'fas fa-eye';
                button.innerHTML = '';
                button.appendChild(icon);
            }
            
            // Toggle password visibility
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Show error message
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            document.getElementById('successMessage').classList.remove('show');
        }

        // Show success message
        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.classList.add('show');
            document.getElementById('errorMessage').classList.remove('show');
        }

        // Hide all messages
        function hideMessages() {
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('successMessage').classList.remove('show');
        }

        // Show loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            hideMessages();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitBtn = document.getElementById('loginSubmitBtn');

            if (!authReady) {
                showError('Authentication system is still loading. Please wait...');
                return;
            }

            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            try {
                // Sign in user (includes Firestore save)
                const userCredential = await window.firebaseSignIn(email, password);
                
                // Store user info globally
                window.currentUserUID = userCredential.user.uid;
                window.currentUserEmail = userCredential.user.email;
                window.currentUserDisplayName = userCredential.user.displayName;
                window.currentUserPhotoURL = userCredential.user.photoURL;
                
                // Determine redirect URL based on email
                const redirectUrl = getRedirectUrl(userCredential.user.email);
                
                showSuccess('Login successful! Redirecting...');
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1000);
            } catch (error) {
                let errorMessage = 'An error occurred during login.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email address.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address format.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many failed attempts. Please try again later.';
                        break;
                    case 'permission-denied':
                        errorMessage = 'Permission denied. Please check Firestore rules.';
                        break;
                    default:
                        errorMessage = error.message || errorMessage;
                }
                
                showError(errorMessage);
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        }

        // Handle register form submission
        async function handleRegister(event) {
            event.preventDefault();
            hideMessages();

            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const submitBtn = document.getElementById('registerSubmitBtn');

            // Validate passwords match
            if (password !== confirmPassword) {
                showError('Passwords do not match. Please try again.');
                return;
            }

            // Validate password length
            if (password.length < 6) {
                showError('Password must be at least 6 characters long.');
                return;
            }

            if (!authReady) {
                showError('Authentication system is still loading. Please wait...');
                return;
            }

            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            try {
                // Create user (includes Firestore save)
                const userCredential = await window.firebaseCreateUser(email, password, name);
                
                // Store user info globally
                window.currentUserUID = userCredential.user.uid;
                window.currentUserEmail = userCredential.user.email;
                window.currentUserDisplayName = userCredential.user.displayName || name;
                window.currentUserPhotoURL = userCredential.user.photoURL;
                
                // Determine redirect URL based on email
                const redirectUrl = getRedirectUrl(userCredential.user.email);
                
                showSuccess('Account created successfully! Redirecting...');
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1000);
            } catch (error) {
                let errorMessage = 'An error occurred during registration.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'An account with this email already exists.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address format.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Please choose a stronger password.';
                        break;
                    case 'permission-denied':
                        errorMessage = 'Permission denied. Please check Firestore rules.';
                        break;
                    default:
                        errorMessage = error.message || errorMessage;
                }
                
                showError(errorMessage);
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        }

        // Handle Google Sign-In
        async function handleGoogleSignIn() {
            hideMessages();

            if (!authReady) {
                showError('Authentication system is still loading. Please wait...');
                return;
            }

            showLoading();

            try {
                // Sign in with Google (includes Firestore save)
                const result = await window.firebaseSignInWithGoogle();
                
                // Store user info globally
                window.currentUserUID = result.user.uid;
                window.currentUserEmail = result.user.email;
                window.currentUserDisplayName = result.user.displayName;
                window.currentUserPhotoURL = result.user.photoURL;
                
                // Wait a bit to ensure Firestore save completes
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Determine redirect URL based on email
                const redirectUrl = getRedirectUrl(result.user.email);
                
                showSuccess('Login successful! Redirecting...');
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1000);
            } catch (error) {
                hideLoading();
                console.error('Google sign-in error:', error);
                
                let errorMessage = 'An error occurred during Google sign-in.';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in popup was closed. Please try again.';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = 'Sign-in was cancelled.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please check Firestore rules.';
                } else {
                    errorMessage = error.message || errorMessage;
                }
                
                showError(errorMessage);
            }
        }

        // Handle forgot password
        function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                showError('Please enter your email address first.');
                document.getElementById('loginEmail').focus();
                return;
            }

            // TODO: Implement password reset functionality
            showError('Password reset functionality will be implemented soon.');
        }
    </script>
</body>
</html>
